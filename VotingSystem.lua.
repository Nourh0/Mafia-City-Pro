-- Modules/VotingSystem.lua
-- Ù†Ø¸Ø§Ù… Ø§Ù„ØªØµÙˆÙŠØª (Voting System)
-- Ø§Ù„ÙˆØ¸ÙŠÙØ©: Ø¬Ù…Ø¹ Ø£ØµÙˆØ§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†ØŒ ÙØ±Ø²Ù‡Ø§ØŒ ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¶Ø­ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£ØºÙ„Ø¨ÙŠØ©

local VotingSystem = {}

-- [1] Ø§Ù„Ø®Ø¯Ù…Ø§Øª ÙˆØ§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯Ø§Øª
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Config = require(ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Config"))

-- [2] Ù…ØªØºÙŠØ±Ø§Øª ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø£ØµÙˆØ§Øª
local currentVotes = {} -- Ø¬Ø¯ÙˆÙ„ Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø£ØµÙˆØ§Øª (Ø§Ù„Ù‡Ø¯Ù = Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙˆØ§Øª)
local isVotingActive = false
local playersWhoVoted = {} -- ØªØªØ¨Ø¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† ØµÙˆØªÙˆØ§ Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±

-- [3] Ø¯Ø§Ù„Ø© Ø¨Ø¯Ø¡ Ø§Ù„ØªØµÙˆÙŠØª (StartVoting)
-- ØªÙ‚ÙˆÙ… Ø¨ØªØµÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… ØªØ¯Ø§Ø®Ù„ Ø§Ù„Ø£ØµÙˆØ§Øª Ù…Ù† Ø§Ù„Ø¬ÙˆÙ„Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
function VotingSystem.StartVoting()
    currentVotes = {}
    playersWhoVoted = {}
    isVotingActive = true
    print("ğŸ—³ï¸ Ø¨Ø¯Ø£ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØµÙˆÙŠØª: Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø£ØµÙˆØ§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†...")
end

-- [4] Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª (CastVote)
-- voter: Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø°ÙŠ ÙŠØµÙˆØª
-- target: Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù (Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥Ø¹Ø¯Ø§Ù…Ù‡)
function VotingSystem.CastVote(voter, target)
    if not isVotingActive then 
        warn("âš ï¸ Ø§Ù„ØªØµÙˆÙŠØª Ù…ØºÙ„Ù‚ Ø­Ø§Ù„ÙŠØ§Ù‹.")
        return 
    end

    if playersWhoVoted[voter.UserId] then
        warn("ğŸš« " .. voter.Name .. " Ø­Ø§ÙˆÙ„ Ø§Ù„ØªØµÙˆÙŠØª Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ø±Ø©.")
        return 
    end

    -- Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù†Ø¹ Ø§Ù„ØªØµÙˆÙŠØª Ù„Ù„Ù†ÙØ³ (Ù…Ù† Ù…Ù„Ù Config)
    if not Config.VotingMechanics.AllowSelfVote and voter == target then
        warn("ğŸš« Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØµÙˆÙŠØª Ù„Ù†ÙØ³Ùƒ.")
        return
    end

    -- ØªØ­Ø¯ÙŠØ¯ Ù‚ÙˆØ© Ø§Ù„ØµÙˆØª (ØµÙˆØª Ø§Ù„Ù‚Ø§Ø¶ÙŠ ÙŠØ­Ø³Ø¨ Ø¨Ù€ 2)
    local voteWeight = 1
    if voter:GetAttribute("Role") == "Judge" then
        voteWeight = Config.VotingMechanics.JudgeVoteWeight or 2
    end

    -- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    local targetName = target.Name
    currentVotes[targetName] = (currentVotes[targetName] or 0) + voteWeight
    playersWhoVoted[voter.UserId] = true

    print("âœ… " .. voter.Name .. " ØµÙˆØª Ø¶Ø¯ " .. targetName .. " (Ù‚ÙˆØ© Ø§Ù„ØµÙˆØª: " .. voteWeight .. ")")
end

-- [5] Ø¯Ø§Ù„Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†ØªÙŠØ¬Ø© (GetResult)
-- Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† "Ø§Ù„Ø£Ø¹Ù„Ù‰ ØªØµÙˆÙŠØªØ§Ù‹"
function VotingSystem.GetResult()
    isVotingActive = false
    local winnerName = nil
    local maxVotes = 0
    local isTie = false

    for targetName, voteCount in pairs(currentVotes) do
        if voteCount > maxVotes then
            maxVotes = voteCount
            winnerName = targetName
            isTie = false
        elseif voteCount == maxVotes then
            isTie = true -- Ø­Ø§Ù„Ø© ØªØ¹Ø§Ø¯Ù„
        end
    end

    if isTie then
        print("âš–ï¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©: ØªØ¹Ø§Ø¯Ù„! Ù„Ù† ÙŠØªÙ… Ø¥Ø¹Ø¯Ø§Ù… Ø£Ø­Ø¯ Ù‡Ø°Ù‡ Ø§Ù„Ø¬ÙˆÙ„Ø©.")
        return nil
    elseif winnerName then
        print("âš–ï¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: Ø³ÙŠØªÙ… Ø¥Ø¹Ø¯Ø§Ù… " .. winnerName .. " Ø¨Ù€ " .. maxVotes .. " ØµÙˆØª.")
        return winnerName
    else
        print("âš–ï¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¥Ø¯Ù„Ø§Ø¡ Ø¨Ø£ÙŠ Ø£ØµÙˆØ§Øª.")
        return nil
    end
end

return VotingSystem
